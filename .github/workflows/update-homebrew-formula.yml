name: Update Homebrew Formula

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to process (e.g., v1.0.1)'
        required: true
        type: string

jobs:
  update-formula:
    name: Update Homebrew Tap Formula
    runs-on: ubuntu-latest

    steps:
      - name: Get release info
        id: release
        run: |
          # Use manual input tag if provided, otherwise extract from GITHUB_REF
          if [ -n "${{ inputs.tag }}" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG="${GITHUB_REF#refs/tags/}"
          fi
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download binaries and calculate checksums
        run: |
          # Download binaries and calculate checksums
          mkdir -p checksums
          cd checksums

          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-arm64" -o doppler-darwin-arm64
          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-amd64" -o doppler-darwin-amd64
          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-linux-amd64" -o doppler-linux-amd64

          SHA256_ARM64=$(sha256sum doppler-darwin-arm64 | cut -d' ' -f1)
          SHA256_AMD64=$(sha256sum doppler-darwin-amd64 | cut -d' ' -f1)
          SHA256_LINUX=$(sha256sum doppler-linux-amd64 | cut -d' ' -f1)

          echo "SHA256_ARM64=$SHA256_ARM64" >> $GITHUB_ENV
          echo "SHA256_AMD64=$SHA256_AMD64" >> $GITHUB_ENV
          echo "SHA256_LINUX=$SHA256_LINUX" >> $GITHUB_ENV

          echo "Checksums:"
          echo "ARM64: $SHA256_ARM64"
          echo "AMD64: $SHA256_AMD64"
          echo "Linux: $SHA256_LINUX"

      - name: Setup SSH for deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: Onix-AI/homebrew-tap
          ssh-key: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          FORMULA_FILE="Formula/doppler-1password-plugin.rb"

          # Update version
          sed -i "s/version \".*\"/version \"${{ steps.release.outputs.version }}\"/" "$FORMULA_FILE"

          # Update download URLs with new version tag
          sed -i "s|releases/download/v[0-9.]\+/doppler-darwin-arm64|releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-arm64|" "$FORMULA_FILE"
          sed -i "s|releases/download/v[0-9.]\+/doppler-darwin-amd64|releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-amd64|" "$FORMULA_FILE"
          sed -i "s|releases/download/v[0-9.]\+/doppler-linux-amd64|releases/download/${{ steps.release.outputs.tag }}/doppler-linux-amd64|" "$FORMULA_FILE"

          # Update checksums
          # macOS ARM64 checksum (first on_arm block)
          sed -i "0,/on_arm do/{/on_arm do/,/end/{s/sha256 \"[^\"]*\"/sha256 \"$SHA256_ARM64\"/}}" "$FORMULA_FILE"

          # macOS AMD64 checksum (first on_intel block)
          sed -i "0,/on_intel do/{/on_intel do/,/end/{s/sha256 \"[^\"]*\"/sha256 \"$SHA256_AMD64\"/}}" "$FORMULA_FILE"

          # Linux AMD64 checksum (inside on_linux block)
          sed -i "/on_linux do/,/^  end/{s/sha256 \"[^\"]*\"/sha256 \"$SHA256_LINUX\"/}" "$FORMULA_FILE"

          echo "Formula updated:"
          cat "$FORMULA_FILE"

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/doppler-1password-plugin.rb
          git commit -m "Update doppler-1password-plugin to ${{ steps.release.outputs.tag }}

          Automated update from release ${{ steps.release.outputs.tag }}

          Checksums:
          - macOS ARM64: ${{ env.SHA256_ARM64 }}
          - macOS AMD64: ${{ env.SHA256_AMD64 }}
          - Linux AMD64: ${{ env.SHA256_LINUX }}"

          git push
