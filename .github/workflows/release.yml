name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build for ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: darwin
            arch: amd64
            runner: macos-latest
          - os: darwin
            arch: arm64
            runner: macos-latest
          - os: linux
            arch: amd64
            runner: ubuntu-latest
          - os: windows
            arch: amd64
            runner: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Prepare build environment
        run: |
          # Copy our doppler plugin into submodule
          cp -r plugins/doppler vendor/shell-plugins/plugins/doppler
          cd vendor/shell-plugins

          # Validate plugin (only on first matrix job)
          if [ "${{ matrix.os }}" = "darwin" ] && [ "${{ matrix.arch }}" = "arm64" ]; then
            make doppler/validate
          fi

          # Generate registry with all plugins
          make registry

      - name: Build plugin
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          cd vendor/shell-plugins
          mkdir -p ../../dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            go build -o ../../dist/doppler-${{ matrix.os }}-${{ matrix.arch }}.exe -ldflags="-X 'main.PluginName=doppler'" ./cmd/contrib/build/
          else
            go build -o ../../dist/doppler-${{ matrix.os }}-${{ matrix.arch }} -ldflags="-X 'main.PluginName=doppler'" ./cmd/contrib/build/
          fi

      - name: Generate checksum
        run: |
          cd dist
          if [ "${{ matrix.os }}" = "windows" ]; then
            sha256sum doppler-${{ matrix.os }}-${{ matrix.arch }}.exe > doppler-${{ matrix.os }}-${{ matrix.arch }}.exe.sha256
          else
            sha256sum doppler-${{ matrix.os }}-${{ matrix.arch }} > doppler-${{ matrix.os }}-${{ matrix.arch }}.sha256
          fi
          cat *.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: doppler-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: doppler-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true

  update-formula:
    name: Update Homebrew Tap Formula
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Get release info
        id: release
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Download binaries and calculate checksums
        run: |
          # Download binaries and calculate checksums
          mkdir -p checksums
          cd checksums

          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-arm64" -o doppler-darwin-arm64
          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-amd64" -o doppler-darwin-amd64
          curl -sL "https://github.com/${{ github.repository }}/releases/download/${{ steps.release.outputs.tag }}/doppler-linux-amd64" -o doppler-linux-amd64

          SHA256_ARM64=$(sha256sum doppler-darwin-arm64 | cut -d' ' -f1)
          SHA256_AMD64=$(sha256sum doppler-darwin-amd64 | cut -d' ' -f1)
          SHA256_LINUX=$(sha256sum doppler-linux-amd64 | cut -d' ' -f1)

          echo "SHA256_ARM64=$SHA256_ARM64" >> $GITHUB_ENV
          echo "SHA256_AMD64=$SHA256_AMD64" >> $GITHUB_ENV
          echo "SHA256_LINUX=$SHA256_LINUX" >> $GITHUB_ENV

          echo "Checksums:"
          echo "ARM64: $SHA256_ARM64"
          echo "AMD64: $SHA256_AMD64"
          echo "Linux: $SHA256_LINUX"

      - name: Setup SSH for deploy key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: Onix-AI/homebrew-tap
          ssh-key: ${{ secrets.HOMEBREW_TAP_DEPLOY_KEY }}
          path: homebrew-tap

      - name: Update formula
        run: |
          cd homebrew-tap
          FORMULA_FILE="Formula/doppler-1password-plugin.rb"

          # Update version
          sed -i "s/version \".*\"/version \"${{ steps.release.outputs.version }}\"/" "$FORMULA_FILE"

          # Update download URLs with new version tag
          sed -i "s|releases/download/v[0-9.]\+/doppler-darwin-arm64|releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-arm64|" "$FORMULA_FILE"
          sed -i "s|releases/download/v[0-9.]\+/doppler-darwin-amd64|releases/download/${{ steps.release.outputs.tag }}/doppler-darwin-amd64|" "$FORMULA_FILE"
          sed -i "s|releases/download/v[0-9.]\+/doppler-linux-amd64|releases/download/${{ steps.release.outputs.tag }}/doppler-linux-amd64|" "$FORMULA_FILE"

          # Update checksums - target the line after each URL
          # macOS ARM64 checksum
          sed -i "/doppler-darwin-arm64/{n;s/sha256 \"[^\"]*\"/sha256 \"$SHA256_ARM64\"/}" "$FORMULA_FILE"

          # macOS AMD64 checksum
          sed -i "/doppler-darwin-amd64/{n;s/sha256 \"[^\"]*\"/sha256 \"$SHA256_AMD64\"/}" "$FORMULA_FILE"

          # Linux AMD64 checksum
          sed -i "/doppler-linux-amd64/{n;s/sha256 \"[^\"]*\"/sha256 \"$SHA256_LINUX\"/}" "$FORMULA_FILE"

          echo "Formula updated:"
          cat "$FORMULA_FILE"

      - name: Commit and push changes
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add Formula/doppler-1password-plugin.rb
          git commit -m "Update doppler-1password-plugin to ${{ steps.release.outputs.tag }}

          Automated update from release ${{ steps.release.outputs.tag }}

          Checksums:
          - macOS ARM64: ${{ env.SHA256_ARM64 }}
          - macOS AMD64: ${{ env.SHA256_AMD64 }}
          - Linux AMD64: ${{ env.SHA256_LINUX }}"

          git push
